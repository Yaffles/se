<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Software Engineering Assessments</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <script>
    let pyodideReady = loadPyodide(); // promise
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .slider-arrow {
      cursor: pointer; position: absolute; top: 50%; padding: 16px;
      color: white; font-weight: bold; font-size: 18px;
      transition: 0.6s ease; border-radius: 0 3px 3px 0;
      background-color: rgba(0,0,0,0.5);
    }
    .slider-arrow.next { right: 0; border-radius: 3px 0 0 3px; }
    .slider-arrow:hover { background-color: rgba(0,0,0,0.8); }
    .sortable-item.dragging { opacity: 0.5; background-color: #e0e7ff; }
    .sortable-list.drag-over { border-style: dashed; }
    .stimulus ul li { text-indent: 0 !important; }
    .question-content ul {list-style:disc !important; margin:auto !important; padding: 20px !important; }

  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-6">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Software Engineering Assessments</h1>

    </header>

    <div id="main-container"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const exam = urlParams.get("exam");
    const mainContainer = document.getElementById("main-container");

    // Map exam IDs to JSON files
    const examFiles = {
      cssa_familiarisation: "data/cssa_familiarisation.json",
      nsb: "data/nsb.json",
      cssa_trial: "data/cssa_trial.json",
      random: "data/girraween.json"
      // Add more exams here later
    };

    if (!exam) {
      // Landing page
      document.querySelector('header').innerHTML += `
        <p class="text-gray-600 mt-2">Choose a test to begin</p>
      `;
      mainContainer.innerHTML = `
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <a href="?exam=cssa_familiarisation" class="block bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">CSSA Familiarisation</h2>
            <p class="text-gray-600 mt-2">Practice familiarisation questions for the CSSA Software Engineering exam.</p>
          </a>
            <!-- nsb exam -->
          <a href="?exam=nsb" class="block bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">NSB Exam</h2>
            <p class="text-gray-600 mt-2">NSB Software Engineering exam.</p>
          </a>
          <!-- cssa_trial exam -->
          <a href="?exam=cssa_trial" class="block bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">CSSA Trial Exam</h2>
            <p class="text-gray-600 mt-2">CSSA Trial Software Engineering exam.</p>
          </a>
          <!-- random exam -->
          <a href="?exam=random" class="block bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">Girraween Exam</h2>
            <p class="text-gray-600 mt-2">Girraween High School Software Engineering exam.</p>
          </a>
        </div>
      `;
    } else {
      // Exam mode
        mainContainer.innerHTML = `
            <div class="mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Exam: ${exam.replace(/_/g, ' ').toUpperCase()}</h2>
            <p class="text-gray-600">Please answer the following questions:</p>
            </div>
        `;

        // add home / back button to top header section
        document.querySelector('header').innerHTML += `
          <a href="/" class="text-indigo-600 hover:underline mt-4 inline-block">← Back to exams</a>
        `;


      mainContainer.innerHTML += `<div id="questions-container" class="space-y-8"></div>`;

      if (!examFiles[exam]) {
        document.getElementById("questions-container").innerHTML =
          `<div class="text-red-600">❌ Unknown exam: ${exam}</div>`;
      } else {
        // --- BEGIN exam rendering logic ---
        fetch(examFiles[exam])
        .then(response => response.json())
        .then(jsonData => {
          const questionsContainer = document.getElementById('questions-container');

          jsonData.forEach((questionData, index) => {
            console.log(".")
            // for each part
            if (!questionData.parts || questionData.parts.length === 0) return;

            questionData.parts.forEach(part => {
              const questionPart = part;
              const questionElement = document.createElement('div');
              questionElement.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200';

            let stimulusHTML = '';
            if (questionData.stimulusContentItemCollection?.items) {
              stimulusHTML = '<div class="stimulus bg-gray-50 p-4 rounded-md mb-4 border border-gray-200">';
              questionData.stimulusContentItemCollection.items.forEach(item => {
                if (item.type === 'RICH_TEXT') {
                  stimulusHTML += `<div class="prose max-w-none">${item.text}</div>`;
                } else if (item.type === 'IMAGE_SLIDER' && item.files) {
                  stimulusHTML += `
                    <div class="relative" id="slider-${questionData.id}">
                      ${item.files.map((file, i) => `
                        <div class="slide ${i === 0 ? '' : 'hidden'}">
                          <img src="${file.url}" alt="Slide ${i+1}" class="w-full h-auto rounded-lg"
                               onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/4a5568?text=Image+Not+Found';">
                        </div>
                      `).join('')}
                      <a class="slider-arrow prev" onclick="changeSlide(-1, 'slider-${questionData.id}')">&#10094;</a>
                      <a class="slider-arrow next" onclick="changeSlide(1, 'slider-${questionData.id}')">&#10095;</a>
                    </div>`;
                } else if (item.type === 'IMAGE' && item.files) {
                  stimulusHTML += `
                    <div class="relative">
                      ${item.files.map((file, i) => `
                        <div class="slide ${i === 0 ? '' : 'hidden'}">
                          <img src="${file.url}" alt="Slide ${i+1}" class="w-full h-auto rounded-lg"
                               onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/4a5568?text=Image+Not+Found';">
                        </div>
                      `).join('')}
                    </div>`;
                }
              });
              stimulusHTML += '</div>';
            }

            let questionContentHTML = '';
            if (questionPart.content.contentItemCollection) {
              questionPart.content.contentItemCollection.items.forEach(item => {
                questionContentHTML += `<div class="prose max-w-none">${item.text}</div>`;
              });
            }

            let answerHTML = '<div class="mt-4 space-y-3">';
            const answerParams = questionPart.answer.parameters;

            if (answerParams.type === 'MULTI_CHOICE') {
              const isMultipleCorrect = answerParams.settings.multipleCorrectOptions;
              const inputType = isMultipleCorrect ? 'checkbox' : 'radio';
              answerParams.options.forEach(option => {
                answerHTML += `
                  <label class="flex items-center p-3 rounded-md border border-gray-200 hover:bg-gray-50 transition">
                    <input type="${inputType}" name="question-${questionData.id}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                    <span class="ml-3 text-gray-700">${option.text}</span>
                  </label>`;
              });
            } else if (answerParams.type === 'SHORT') {
              answerHTML += `<textarea class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="4" placeholder="Your answer here..."></textarea>`;
            } else if (answerParams.type === 'OBJECTIVE_RESPONSE') {
              answerHTML += '<div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300">';
              answerHTML += '<thead><tr class="bg-gray-100">';
              answerParams.header.forEach(header => {
                answerHTML += `<th class="p-2 border border-gray-300 text-center">${header.text}</th>`;
              });
              answerHTML += '</tr></thead><tbody>';
              answerParams.rows.forEach((row, rowIndex) => {
                answerHTML += '<tr class="hover:bg-gray-50">';
                row.cells.forEach((cell, cellIndex) => {
                  if (cellIndex === 0) {
                    answerHTML += `<td class="p-2 border border-gray-300 font-medium">${cell.text}</td>`;
                  } else {
                    answerHTML += `<td class="p-2 border border-gray-300 text-center"><input type="radio" name="row-${questionData.id}-${rowIndex}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"></td>`;
                  }
                });
                answerHTML += '</tr>';
              });
              answerHTML += '</tbody></table></div>';
            } else if (answerParams.type === 'SORTING_TABLE') {
              answerHTML += `<ul id="sortable-list-${questionData.id}" class="sortable-list border border-gray-300 rounded-md p-2 space-y-2 bg-gray-50">`;
              answerParams.rows.forEach(row => {
                answerHTML += `<li class="p-3 bg-white border border-gray-200 rounded-md shadow-sm cursor-move sortable-item" draggable="true">${row.cells[0].text}</li>`;
              });
              answerHTML += '</ul><p class="text-sm text-gray-500 mt-2">Drag and drop to reorder the items.</p>'
            } else if (answerParams.type === 'CODING') {
              const defaultCode = answerParams.defaultCode || '# Write your Python code here...';
              const editorId = `editor-${questionData.id}`;
              const outputId = `output-${questionData.id}`;
              const runBtnId = `run-btn-${questionData.id}`;
              answerHTML += `
                <div class="coding-block space-y-3">
                  <textarea id="${editorId}" class="w-full p-4 border-gray-600 rounded-md bg-gray-900 text-white font-mono text-sm" rows="10">${defaultCode}</textarea>
                  <button id="${runBtnId}" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">Run Code</button>
                  <pre id="${outputId}" class="w-full p-4 bg-gray-100 rounded-md text-sm text-gray-800 whitespace-pre-wrap overflow-x-auto"></pre>
                </div>`;
              setTimeout(() => {
                document.getElementById(runBtnId).addEventListener("click", async () => {
                  const code = document.getElementById(editorId).value;
                  const outputEl = document.getElementById(outputId);
                  outputEl.textContent = "⏳ Running...";
                  try {
                    const pyodide = await pyodideReady;
                    await pyodide.runPythonAsync(`
import sys, builtins
class OutputCatcher:
    def __init__(self): self.data = ""
    def write(self, s): self.data += s
    def flush(self): pass
catcher = OutputCatcher()
sys.stdout = catcher
sys.stderr = catcher
def custom_input(prompt_text=""):
    from js import prompt
    return prompt(str(prompt_text)) or ""
builtins.input = custom_input
`);
                    await pyodide.runPythonAsync(code);
                    const result = pyodide.runPython("catcher.data");
                    outputEl.textContent = result || "(no output)";
                  } catch (err) {
                    outputEl.textContent = "❌ Error: " + err;
                  }
                });
              }, 0);
            } else if (answerParams.type === 'SQL') {
              const defaultSQL = answerParams.defaultCode || '-- Write your SQL query here...';
              const editorId = `editor-${questionData.id}`;
              const outputId = `output-${questionData.id}`;
              const runBtnId = `run-sql-${questionData.id}`;
              answerHTML += `
                <div class="sql-block space-y-3">
                  <textarea id="${editorId}" class="w-full p-4 border-gray-600 rounded-md bg-gray-900 text-white font-mono text-sm" rows="10">${defaultSQL}</textarea>
                  <button id="${runBtnId}" class="px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700 transition">Run SQL</button>
                  <div id="${outputId}" class="overflow-x-auto w-full p-4 bg-gray-100 rounded-md text-sm text-gray-800"></div>
                </div>`;
              setTimeout(async () => {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}` });
                const db = new SQL.Database();
                if (answerParams.datasetSetupQuery) {
                  try { db.run(answerParams.datasetSetupQuery); } catch (err) { console.error("Dataset setup failed:", err); }
                }
                document.getElementById(runBtnId).addEventListener("click", () => {
                  const sqlCode = document.getElementById(editorId).value;
                  const outputEl = document.getElementById(outputId);
                  outputEl.innerHTML = "⏳ Running...";
                  try {
                    const result = db.exec(sqlCode);
                    if (result.length === 0) { outputEl.textContent = "(no output)"; return; }
                    let html = "<table class='border border-gray-300 bg-white'><thead><tr>";
                    result[0].columns.forEach(col => { html += `<th class="border border-gray-300 px-2 py-1 bg-gray-100">${col}</th>`; });
                    html += "</tr></thead><tbody>";
                    result[0].values.forEach(row => {
                      html += "<tr>";
                      row.forEach(val => { html += `<td class="border border-gray-300 px-2 py-1">${val}</td>`; });
                      html += "</tr>";
                    });
                    html += "</tbody></table>";
                    outputEl.innerHTML = html;
                  } catch (err) {
                    outputEl.textContent = "❌ Error: " + err;
                  }
                });
              }, 0);
            } else if (answerParams.type === 'DRAWING_V2') {
              answerHTML += `
                <div class="mt-4">
                  <iframe src="https://excalidraw.com/?embed=1" width="100%" height="600" style="border:1px solid #e2e8f0; border-radius: 8px;"></iframe>
                </div>`;
            }
            answerHTML += '</div>';

            questionElement.innerHTML = `
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">${questionPart.title}</h2>
                <span class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">${questionPart.metadata.mark} ${questionPart.metadata.mark === 1 ? 'mark' : 'marks'}</span>
              </div>
              ${stimulusHTML}
              <div class="question-content">${questionContentHTML}</div>
              ${answerHTML}
            `;
            questionsContainer.appendChild(questionElement);
          });
            });

          // Sorting
          const sortableLists = document.querySelectorAll('.sortable-list');
          sortableLists.forEach(list => {
            const items = list.querySelectorAll('.sortable-item');
            items.forEach(item => {
              item.addEventListener('dragstart', () => { setTimeout(() => item.classList.add('dragging'), 0); });
              item.addEventListener('dragend', () => { item.classList.remove('dragging'); });
            });
            list.addEventListener('dragover', e => {
              e.preventDefault();
              list.classList.add('drag-over');
              const draggingItem = document.querySelector('.dragging');
              const afterElement = getDragAfterElement(list, e.clientY);
              if (afterElement == null) list.appendChild(draggingItem);
              else list.insertBefore(draggingItem, afterElement);
            });
            list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
            list.addEventListener('drop', () => list.classList.remove('drag-over'));
          });
          function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
              else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
          }

          // Image sliders
          let slideIndexes = {};
          window.showSlides = function(n, sliderId) {
            let slider = document.getElementById(sliderId);
            if (!slider) return;
            let slides = slider.getElementsByClassName("slide");
            if (n > slides.length) { slideIndexes[sliderId] = 1 }
            if (n < 1) { slideIndexes[sliderId] = slides.length }
            for (let i = 0; i < slides.length; i++) { slides[i].style.display = "none"; }
            if (slides[slideIndexes[sliderId] - 1]) {
              slides[slideIndexes[sliderId] - 1].style.display = "block";
            }
          }
          window.changeSlide = function(n, sliderId) {
            if (!slideIndexes[sliderId]) slideIndexes[sliderId] = 1;
            showSlides(slideIndexes[sliderId] += n, sliderId);
          }
          document.querySelectorAll('[id^="slider-"]').forEach(slider => {
            slideIndexes[slider.id] = 1;
            showSlides(1, slider.id);
          });
        })
        .catch(error => {
          console.error('Error loading JSON:', error);
          document.getElementById('questions-container').innerHTML =
            '<div class="text-red-600">Failed to load questions.</div>';
        });
        // --- END exam rendering logic ---
      }
    }
  </script>
</body>
</html>
